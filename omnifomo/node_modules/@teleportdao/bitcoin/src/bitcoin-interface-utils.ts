import type { Network } from "bitcoinjs-lib"
import networks from "./utils/networks"
import {
  createAddressObjectByHash,
  createAddressObjectByAddress,
  createAddressObjectByPublicKey,
  createAddressObjectByScript,
} from "./bitcoin-utils"

export class BitcoinInterfaceUtils {
  testnet: boolean
  network: Network
  constructor(networkName: string) {
    this.testnet = networkName.includes("_testnet")
    this.network = networks[networkName]
  }

  convertHashToAddress(hashHex: string, addressType: string) {
    let addressObj = createAddressObjectByHash(
      { addressType, hash: Buffer.from(hashHex, "hex") },
      this.network,
    )
    if (!addressObj.address) throw new Error("incorrect input")
    return addressObj.address
  }

  convertScriptToAddress(scriptHex: string, addressType: string) {
    let addressObj = createAddressObjectByScript(
      { addressType, script: Buffer.from(scriptHex, "hex") },
      this.network,
    )
    if (!addressObj.address) throw new Error("incorrect input")
    return addressObj.address
  }

  convertAddressToScript(address: string) {
    let { addressObject, addressType } = createAddressObjectByAddress(address, this.network)
    const hash = addressType === "p2tr" ? addressObject.pubkey : addressObject.hash
    return {
      script: addressObject.output,
      hash,
      addressType,
    }
  }

  convertAddressToObject(address: string) {
    let addObj = createAddressObjectByAddress(address, this.network)
    return addObj
  }

  createAddressObjectByPublicKey(publicKey: string, addressType: string) {
    let addObj = createAddressObjectByPublicKey(
      { publicKey: Buffer.from(publicKey, "hex"), addressType },
      this.network,
    )
    return addObj
  }
}

export default BitcoinInterfaceUtils
