import * as bitcoin from "bitcoinjs-lib"
import { LEAF_VERSION_TAPSCRIPT } from "bitcoinjs-lib/src/payments/bip341"
import { BitcoinTransactionBuilder } from "./bitcoin-transaction-builder"
import { getOrdinalScript, toXOnly } from "../helper/ordinal-helper"
import { ExtendedUtxo, Target } from "./transaction-builder"

export class OrdinalTransactionBuilder extends BitcoinTransactionBuilder {
  async createNftPsbt({
    extendedUtxo,
    nftExtendedUtxo,
    receiverAddress,
    feeRate,
    changeAddress,
    otherTargets,
  }: {
    nftExtendedUtxo: ExtendedUtxo
    extendedUtxo: ExtendedUtxo[]
    feeRate: number
    changeAddress: string
    receiverAddress: string
    otherTargets?: Target[]
  }) {
    let targets: Target[] = [
      {
        address: receiverAddress,
        value: nftExtendedUtxo.value,
      },
    ]

    if (otherTargets) targets.push(...otherTargets)

    if (!changeAddress && targets.length === 0) throw new Error("no target")
    let changeObject = {
      address: changeAddress,
    }
    let { inputs, outputs, change, fee } = await this.filterAndConvertTxDataToStandardFormat({
      extendedUtxo: [nftExtendedUtxo, ...extendedUtxo],
      targets,
      changeObject,
      feeRate,
      selectType: "inOrder",
    })

    let unsignedTx = this.createUnsignedTransaction({
      inputs,
      outputs,
      change,
      fee,
      feeRate,
    })

    return unsignedTx
  }

  createOrdinalAddress(
    file: {
      buffer: Buffer
      type: string
    },
    publicKey: Buffer,
  ) {
    const internalPublicKey = toXOnly(publicKey).toString("hex")
    let leafScript = getOrdinalScript(file, internalPublicKey)

    const scriptTree = {
      output: leafScript,
    }
    const redeem = {
      output: leafScript,
      redeemVersion: LEAF_VERSION_TAPSCRIPT,
    }

    const p2trTapOrdinalScript = bitcoin.payments.p2tr({
      internalPubkey: Buffer.from(internalPublicKey, "hex"),
      scriptTree,
      network: this.network,
      redeem,
    })
    let ordinalAddress = p2trTapOrdinalScript.address!
    const controlBlock = p2trTapOrdinalScript.witness![p2trTapOrdinalScript.witness!.length - 1]
    return {
      ordinalAddress,
      ordinalScript: p2trTapOrdinalScript.output!,
      redeem,
      controlBlock,
    }
  }

  createInscribeUnsignedTx(
    ordinalSpendDetails: {
      ordinalAddress: string
      ordinalScript: Buffer
      redeem: {
        output: Buffer
        redeemVersion: number
      }
      controlBlock: Buffer
    },
    inscribeDeposit: {
      hash: string
      index: number
      value: number
    },
    receiverAddress: string,
    ordinalAmount = 600,
  ) {
    const psbt = new bitcoin.Psbt({ network: this.network })
      .addInput({
        ...inscribeDeposit,
        witnessUtxo: { value: inscribeDeposit.value, script: ordinalSpendDetails.ordinalScript },
        // tapInternalKey: toXOnly(node.publicKey),
        // tapMerkleRoot: p2trTapOrdinalScript.hash!,
        tapLeafScript: [
          {
            leafVersion: ordinalSpendDetails.redeem.redeemVersion,
            script: ordinalSpendDetails.redeem.output,
            controlBlock: ordinalSpendDetails.controlBlock,
          },
        ],
      })
      .addOutput({
        value: ordinalAmount,
        address: receiverAddress,
      })

    return {
      unsignedTransaction: psbt.toBase64(),
      inputs: [inscribeDeposit],
      outputs: [
        {
          value: ordinalAmount,
          address: receiverAddress,
        },
      ],
      fee: inscribeDeposit.value - ordinalAmount,
      possibleTxId: this.getUnsignedPsbtTxId(psbt.toBase64()),
    }
  }
}
