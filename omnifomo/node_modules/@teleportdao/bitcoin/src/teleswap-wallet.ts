import { teleswap, chainInfo } from "@teleportdao/configs"
import type {
  ExtendedUtxo,
  SignerInfo,
  TargetAddress,
} from "./transaction-builder/transaction-builder"
import { BitcoinBaseWallet, FeeRateType } from "./bitcoin-wallet-base"
import { generateWrapOpReturn } from "./helper/teleswap-helper"

export type TransferRequest = {
  changeAddress?: string
  lockerAddress: string
  amount: number
  fullAmount?: boolean
  //-----------
  chainId: number
  appId: number
  recipientAddress: string // 20 bytes
  percentageFee: number // 2 bytes in satoshi
  speed?: number | boolean // 1 byte
  isExchange?: boolean
  exchangeTokenAddress?: string // 20 bytes
  outputAmount?: number // 28 bytes
  deadline?: number // 4 bytes
  isFixedToken?: boolean // 1 byte
  feeSpeed?: "normal" | "fast" | "slow"
  staticFeeRate?: number
}

export class TeleswapWallet extends BitcoinBaseWallet {
  // signed methods
  async wrap(
    recipientAddress: string,
    amount: string,
    networkFee: string,
    lockerAddress: string,
    chainId: number, // 80001
    exchange?: {
      outputToken: string
      outputAmount: string
      bridgePercentageFee?: number
    },
    appId = exchange
      ? teleswap.requestAppId.WrapAndSwap.default
      : teleswap.requestAppId.Wrap.default,
    speed = false,
    fee: FeeRateType = "normal",
    thirdPartyId?: number,
    staticExtendedUtxo?: ExtendedUtxo[],
    changeAddress?: string,
    fullAmount = false,
  ) {
    if (!this.signerInfo || !this.privateKey) {
      throw new Error("account not initialized")
    }
    let unsignedTransaction = await this.wrapUnsigned(
      recipientAddress,
      amount,
      networkFee,
      lockerAddress,
      chainId,
      this.signerInfo,
      exchange,
      appId,
      speed,
      fee,
      thirdPartyId,
      staticExtendedUtxo,
      changeAddress,
      fullAmount,
    )
    let signedPsbt = await this.signer.signPsbt(unsignedTransaction, this.privateKey)
    return this.sendSignedPsbt(signedPsbt)
  }

  // unsigned methods

  async wrapUnsigned(
    recipientAddress: string,
    amount: string,
    networkFee: string,
    lockerAddress: string,
    chainId: number, // 80001
    signer: SignerInfo,
    exchange?: {
      outputToken: string
      outputAmount: string
      bridgePercentageFee?: number
    },
    appId = exchange
      ? teleswap.requestAppId.WrapAndSwap.default
      : teleswap.requestAppId.Wrap.default,
    speed = false,
    fee: FeeRateType = "normal",
    thirdPartyId?: number,
    staticExtendedUtxo?: ExtendedUtxo[],
    changeAddress?: string,
    fullAmount = false,
  ) {
    const dataHex = generateWrapOpReturn({
      chainId,
      appId,
      recipientAddress,
      networkFee,
      speed,
      isExchange: !!exchange,
      outputAmount: exchange?.outputAmount,
      outputToken: exchange?.outputToken,
      bridgePercentageFee: exchange?.bridgePercentageFee,
      thirdPartyId,
    })
    let extendedUtxo = staticExtendedUtxo || (await this.getExtendedUtxo(signer))
    let feeRate = await this.getFeeRate(fee)

    const targets = fullAmount
      ? [this.transactionBuilder.getOpReturnTarget(dataHex)]
      : [
          {
            address: lockerAddress,
            value: +amount,
          },
          this.transactionBuilder.getOpReturnTarget(dataHex),
        ]

    const sequenceNumber = speed === true ? this.transactionBuilder.NO_RBF_SEQUENCE : undefined
    const unsignedTx = this.transactionBuilder.processUnsignedTransaction({
      extendedUtxo,
      feeRate,
      targets,
      changeAddress: fullAmount ? lockerAddress : changeAddress || signer.address,
      fullAmount,
      sequenceNumber,
    })

    return unsignedTx
  }
}
export default TeleswapWallet
