// not complete
import { AxiosInstance } from "axios"
import { getAxiosInstance } from "../../utils/tools"
import { ConfirmedTransaction } from "../types"

class BitcoinRPC {
  axios: AxiosInstance
  constructor({
    headers = {},
    url: baseUrl,
    auth,
  }: {
    headers?: {
      [key: string]: string
    }
    url: string
    auth?: {
      username: string
      password: string
    }
  }) {
    this.axios = BitcoinRPC.getAxiosInstance({
      baseUrl,
      headers,
      auth,
      timeout: 3 * 60000,
    })
  }

  static getAxiosInstance(provider: {
    baseUrl: string
    timeout?: number
    headers?: {
      [key: string]: string
    }
    auth?: {
      username: string
      password: string
    }
  }) {
    return getAxiosInstance(provider)
  }

  static getRpcBody(method: string, params: (string | number | boolean)[] = []) {
    return {
      jsonrpc: "2.0",
      id: "teleport-dao",
      method,
      params,
    }
  }

  async getChainInfo() {
    let response = await this.axios.post("/", BitcoinRPC.getRpcBody("getblockchaininfo"))
    return response.data.result
  }

  async getLatestBlockNumber() {
    let response = await this.axios.post("/", BitcoinRPC.getRpcBody("getblockcount"))
    return response.data.result as number
  }

  async getBlockHash(blockNumber: number) {
    let response = await this.axios.post("/", BitcoinRPC.getRpcBody("getblockhash", [+blockNumber]))
    return response.data.result as string
  }

  async getBlockByBlockHash(blockHash: string, verbosity = 1) {
    let response = await this.axios.post(
      "/",
      BitcoinRPC.getRpcBody("getblock", [blockHash, Number(verbosity)]),
      {
        headers: {
          "Content-Type": "application/json",
        },
      },
    )
    return response.data.result
  }

  async getBlockHeaderByBlockHash(blockHash: string) {
    let response = await this.axios.post(
      "/",
      BitcoinRPC.getRpcBody("getblockheader", [blockHash, false]),
    )
    return response.data.result as string
  }

  async getBlockByBlockNumber(blockNumber: number, verbosity: number) {
    return this.getBlockByBlockHash(await this.getBlockHash(blockNumber), verbosity)
  }

  async getTransaction(txId: string): Promise<ConfirmedTransaction> {
    let response = await this.axios.post(
      "/",
      BitcoinRPC.getRpcBody("getrawtransaction", [txId, true]),
    )
    let tx = response.data.result
    if (!tx) throw new Error(`bitcoin transaction ${txId} not found`)

    let block = tx.blockhash ? await this.getBlockByBlockHash(tx.blockhash) : {}
    return {
      txId: tx.txid,
      version: tx.version,
      locktime: tx.locktime,
      blockNumber: block.height || null,
      blockHash: tx.blockhash || null,
      vout: tx.vout.map((vo: any) => ({
        address: vo.scriptPubKey.address || null,
        script: vo.scriptPubKey.hex,
        value: Number((Number(vo.value) * 1e8).toFixed()),
      })),
      vin: tx.vin.map((vi: any) => ({
        txId: vi.txid,
        index: vi.vout,
      })),
    }
  }

  async getRawTransaction(txId: string) {
    let response = await this.axios.post(
      "/",
      BitcoinRPC.getRpcBody("getrawtransaction", [txId, true]),
    )
    return response.data.result.hex as string
  }

  async getTxOutProof(txId: string) {
    let response = await this.axios.post("/", BitcoinRPC.getRpcBody("gettxoutproof", [txId, true]))
    return response.data.result.hex
  }

  async getBlockTransactionIds(blockHash: string) {
    let block = await this.getBlockByBlockHash(blockHash)
    return block.tx
  }

  async sendRawTransaction(txHex: string, maxFeeRate = 0.1) {
    let response = await this.axios.post(
      "/",
      BitcoinRPC.getRpcBody("sendrawtransaction", [txHex, maxFeeRate]),
    )
    return response.data.result
  }

  // custom

  async getBlockHeaderHex(blockNumber: number) {
    const hash = await this.getBlockHash(blockNumber)
    const result = await this.getBlockHeaderByBlockHash(hash)
    return result
  }

  async getEstimateFeeByNumberOfBlock(n: number) {
    let response = await this.axios.post(
      "/",
      BitcoinRPC.getRpcBody("estimatesmartfee", [n, "ECONOMICAL"]),
    )

    return response.data.result.feerate * 10 ** 5
  }

  async getFeeRate(speed = "normal") {
    let fee
    switch (speed) {
      case "slow":
        fee = await this.getEstimateFeeByNumberOfBlock(10)
        break
      case "normal":
        fee = await this.getEstimateFeeByNumberOfBlock(6)
        break
      case "fast":
        fee = await this.getEstimateFeeByNumberOfBlock(3)
        break
      default:
        fee = await this.getEstimateFeeByNumberOfBlock(6)
        break
    }
    return +fee.toFixed()
  }
}

export default BitcoinRPC
