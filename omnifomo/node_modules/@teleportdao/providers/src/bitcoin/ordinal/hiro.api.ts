import { AxiosInstance } from "axios"
import { getAxiosInstance, runWithRetries } from "../../utils/tools"

export interface HiroInscription {
  id: string
  number: number
  address: string
  genesis_address: string
  genesis_block_height: number
  genesis_block_hash: string
  genesis_tx_id: string
  genesis_fee: string
  genesis_timestamp: number
  tx_id: string
  location: string
  output: string
  value: string
  offset: string
  sat_ordinal: string
  sat_rarity: string
  sat_coinbase_height: number
  mime_type: string
  content_type: string
  content_length: number
  timestamp: number
  curse_type: any
  recursive: boolean
  recursion_refs: any
}

export class HiroApi {
  api: AxiosInstance
  constructor({ token }: { token: string }) {
    let apiKey = token
    const baseUrl = "https://api.mainnet.hiro.so/"
    this.api = getAxiosInstance({
      baseUrl,
      headers: {
        "x-hiro-api-key": apiKey,
      },
    })
  }

  async getInscription(inscriptionId: string) {
    try {
      let inscription: HiroInscription = (
        await this.api.get(`/ordinals/v1/inscriptions/${inscriptionId}`)
      )?.data
      return inscription
    } catch (err: any) {
      return null
    }
  }

  async getInscriptionsForAddress(address: string, { limit = 50, offset = 0 }) {
    let inscriptions: HiroInscription[] =
      (
        await this.api.get(`/ordinals/v1/inscriptions`, {
          params: {
            limit,
            offset,
            order: "desc",
            order_by: "genesis_block_height",
            address,
          },
        })
      )?.data?.results || []
    return inscriptions
  }

  async getInscriptionsForAddressWithRetry(
    address: string,
    { limit = 50, offset = 0 },
  ): Promise<HiroInscription[]> {
    return runWithRetries(() => this.getInscriptionsForAddress(address, { limit, offset }), {
      maxTries: 3,
      retrySleep: 3000,
    })
  }

  async getAllInscriptionsForAddress(address: string) {
    let limit = 50
    let offset = 0
    let inscriptions = []
    let result
    do {
      result = await this.getInscriptionsForAddressWithRetry(address, { limit, offset })
      inscriptions.push(...result)
      offset += limit
    } while (result.length === offset)

    return inscriptions
  }

  async getInscriptionWithRetry(inscriptionId: string) {
    return runWithRetries(() => this.getInscription(inscriptionId), {
      maxTries: 3,
      retrySleep: 3000,
    })
  }

  static convertByIdToInscription(inscription: HiroInscription) {
    return {
      owner: inscription.address,
      inscriptionId: inscription.id,
      inscriptionNumber: BigInt(+inscription.number),
      inscriptionTitle: `Inscription ${inscription.number}`,
      contentURI: `https://ordinals.com/content/${inscription.id}`,
      contentType: inscription.content_type,
      contentLength: inscription.content_length + "",
      genesisHeight: +inscription.genesis_block_height,
      genesisTransaction: inscription.genesis_tx_id,
      genesisFee: +inscription.genesis_fee,
      outputLocation: inscription.location,
      satNumber: BigInt(inscription.sat_ordinal),
      satRarity: inscription.sat_rarity,
      //
      satCoinbaseHeight: inscription.sat_coinbase_height,
    }
  }
}
