import { AxiosInstance } from "axios"
import { getAxiosInstance } from "../../utils/tools"

export interface UnisatInscriptionUtxo {
  inscriptionNumber: number
  inscriptionId: string
  offset: number
  moved: boolean
  sequence: number
  isBRC20: boolean
}

export interface UnisatUtxo {
  txid: string
  vout: number
  satoshi: number
  scriptType: string
  scriptPk: string
  codeType: number
  address: string
  height: number
  idx: number
  isOpInRBF: boolean
  inscriptions: UnisatInscriptionUtxo[]
}

export interface UnisatUtxoResponse {
  code: number
  msg: string
  data:
    | {
        cursor: number
        total: number
        totalConfirmed: number
        totalUnconfirmed: number
        totalUnconfirmedSpend: number
        utxo: UnisatUtxo[]
      }
    | undefined
}

export interface UnisatInscription {
  utxo: UnisatUtxo
  address: string
  offset: number
  inscriptionIndex: number
  inscriptionNumber: number
  inscriptionId: string
  contentType: string
  contentLength: number
  contentBody: string
  height: number
  timestamp: number
  inSatoshi: number
  outSatoshi: number
  brc20?: {
    op: string
    tick: string
    lim: string
    amt: string
    decimal: string
  }
  detail: any
}

export interface UnisatInscriptionForAddressResponse {
  code: number
  msg: string
  data:
    | {
        cursor: number
        total: number
        totalConfirmed: number
        totalUnconfirmed: number
        totalUnconfirmedSpend: number
        inscription: UnisatInscription[]
      }
    | undefined
}

export interface UnisatBalanceResponse {
  code: number
  msg: string
  data: {
    address: string
    satoshi: number
    pendingSatoshi: number
    utxoCount: number
    btcSatoshi: number
    btcPendingSatoshi: number
    btcUtxoCount: number
    inscriptionSatoshi: number
    inscriptionPendingSatoshi: number
    inscriptionUtxoCount: number
  }
}

export interface UnisatTxResponse {
  code: number
  msg: string
  data: {
    txid: string
    nIn: number
    nOut: number
    size: number
    witOffset: number
    locktime: number
    inSatoshi: number
    outSatoshi: number
    nNewInscription: number
    nInInscription: number
    nOutInscription: number
    nLostInscription: number
    timestamp: number
    height: number
    blkid: string
    idx: number
    confirmations: number
  }
}

export interface UnisatInscriptionResponse {
  code: number
  msg: string
  data: UnisatInscription | null
}

export interface UnisatTickerResponse {
  code: number
  msg: string
  data: {
    ticker: string
    holdersCount: number
    historyCount: number
    inscriptionNumber: number
    inscriptionId: string
    max: string
    limit: string
    minted: string
    totalMinted: string
    confirmedMinted: string
    confirmedMinted1h: string
    confirmedMinted24h: string
    mintTimes: number
    decimal: number
    creator: string
    txid: string
    deployHeight: number
    deployBlocktime: number
    completeHeight: number
    completeBlocktime: number
    inscriptionNumberStart: number
    inscriptionNumberEnd: number
  }
}

export interface UnisatBrc20TxResponse {
  code: number
  msg: string
  data: {
    height: number
    total: number
    start: number
    detail: {
      ticker: string
      type: string
      valid: boolean
      txid: string
      idx: number
      vout: number
      offset: number
      inscriptionNumber: number
      inscriptionId: string
      from: string
      to: string
      satoshi: number
      fee: number
      amount: string
      overallBalance: string
      transferBalance: string
      availableBalance: string
      height: number
      txidx: number
      blockhash: string
      blocktime: number
    }[]
  }
}

export interface UnisatBrc20BalanceResponse {
  code: number
  msg: string
  data: {
    height: number
    total: number
    start: number
    detail: {
      ticker: string
      overallBalance: string
      transferableBalance: string
      availableBalance: string
      availableBalanceSafe: string
      availableBalanceUnSafe: string
      decimal: number
    }[]
  }
}

export interface UnisatBRC20TransferableInscription {
  data: {
    op: string
    tick: string
    lim: string
    amt: string
    decimal: string
  }
  inscriptionNumber: number
  inscriptionId: string
  satoshi: number
  confirmations: number
}

export interface UnisatBRC20HistoryInscription {
  data: {
    op: string
    tick: string
    lim?: string
    amt?: string
    decimal?: string
    minted?: string
    max?: string
  }
  inscriptionNumber: number
  inscriptionId: string
  satoshi: number
  confirmations: number
}

export interface UnisatBrc20BalanceResponseForTicker {
  code: number
  msg: string
  data: {
    ticker: string
    overallBalance: string
    transferableBalance: string
    availableBalance: string
    availableBalanceSafe: string
    availableBalanceUnSafe: string
    transferableCount: number
    transferableInscriptions: UnisatBRC20TransferableInscription[]
    historyCount: number
    historyInscriptions: UnisatBRC20HistoryInscription[]
  }
}

export interface UnisatBrc20TransferrableBalanceResponseForTicker {
  code: number
  msg: string
  data: {
    height: number
    total: number
    start: number
    detail: UnisatBRC20TransferableInscription[]
  }
}

//

export class UniSat {
  api: AxiosInstance

  constructor(
    {
      token,
    }: {
      token: string
    },
    testnet = false,
  ) {
    const baseUrl = testnet ? "https://open-api-testnet.unisat.io" : "https://open-api.unisat.io"
    this.api = getAxiosInstance({
      baseUrl,
      headers: {
        Authorization: `Bearer ${token}`,
      },
    })
  }

  static convertToNormalUtxo(unisatUtxo: UnisatUtxo[]) {
    return unisatUtxo.map((u) => ({
      address: u.address,
      txId: u.txid,
      index: u.vout,
      value: u.satoshi,
      blockNumber: u.height,
      inscriptions: u.inscriptions.map(({ inscriptionNumber, inscriptionId, moved, isBRC20 }) => ({
        inscriptionNumber,
        inscriptionId,
        moved,
        isBRC20,
      })),
    }))
  }

  // sns
  async getBTCBalance(address: string) {
    const response: UnisatBalanceResponse = (
      await this.api.get(`/v1/indexer/address/${address}/balance`, {})
    )?.data
    return response.data
  }

  async getBTCUtxo(address: string, cursor = 0) {
    const response: UnisatUtxoResponse = (
      await this.api.get(`/v1/indexer/address/${address}/utxo-data`, {
        params: {
          cursor,
          size: 100,
        },
      })
    )?.data
    return response.data
  }

  async getUtxos(address: string) {
    const result = await this.getBTCUtxo(address)
    if (!result) return []
    const utxos = result.utxo.map((tx) => ({
      address,
      txId: tx.txid,
      index: tx.vout,
      value: +tx.satoshi,
      blockNumber: +tx.height,
    }))
    return utxos
  }

  async getInscriptionUtxo(address: string, cursor = 0) {
    const response: UnisatUtxoResponse = (
      await this.api.get(`/v1/indexer/address/${address}/inscription-utxo-data`, {
        params: {
          cursor,
          size: 100,
        },
      })
    )?.data
    return response.data
  }

  async getTxInfo(txId: string) {
    const response: UnisatTxResponse = (await this.api.get(`/v1/indexer/tx/${txId}`, {}))?.data
    return response.data
  }

  async getInscriptionInfo(inscriptionId: string) {
    const response: UnisatInscriptionResponse = (
      await this.api.get(`/v1/indexer/inscription/info/${inscriptionId}`, {})
    )?.data
    return response.data
  }

  async getInscriptionsForAddress(address: string, cursor = 0) {
    const response: UnisatInscriptionForAddressResponse = (
      await this.api.get(`/v1/indexer/address/${address}/inscription-data`, {
        params: {
          cursor,
          size: 100,
        },
      })
    )?.data
    return response.data
  }

  async getBrc20List() {
    const response = (
      await this.api.get(`/v1/indexer/brc20/list`, {
        params: {
          start: 0,
          limit: 100,
        },
      })
    )?.data
    return response.data
  }

  async getBrc20TickerInfo(ticker: string) {
    const response: UnisatTickerResponse = (
      await this.api.get(
        `/v1/indexer/brc20/${Buffer.from(ticker, "utf8").toString("hex")}/info`,
        {},
      )
    )?.data
    return response.data
  }

  async getBrc20TickerTxHistory(ticker: string, txId: string) {
    const response: UnisatBrc20TxResponse = (
      await this.api.get(
        `v1/indexer/brc20/${Buffer.from(ticker, "utf8").toString("hex")}/tx/${txId}/history`,
        {},
      )
    )?.data
    return response.data
  }

  async getAddressBrc20History(address: string) {
    const response: UnisatBrc20TxResponse = (
      await this.api.get(`/v1/indexer/address/${address}/brc20/history`, {})
    )?.data
    return response.data
  }

  async getBrc20AddressBalances(address: string) {
    const response: UnisatBrc20BalanceResponse = (
      await this.api.get(`/v1/indexer/address/${address}/brc20/summary`, {})
    )?.data
    return response.data
  }

  async getBrc20AddressBalanceForTicker(address: string, ticker: string) {
    const response: UnisatBrc20BalanceResponseForTicker = (
      await this.api.get(
        `/v1/indexer/address/${address}/brc20/${Buffer.from(ticker, "utf8").toString("hex")}/info`,
        {},
      )
    )?.data
    return response.data
  }

  async getBrc20AddressTransferrableInscriptions(address: string, ticker: string) {
    const response: UnisatBrc20TransferrableBalanceResponseForTicker = (
      await this.api.get(
        `/v1/indexer/address/${address}/brc20/${Buffer.from(ticker, "utf8").toString(
          "hex",
        )}/transferable-inscriptions`,
        {},
      )
    )?.data
    return response.data
  }
}

export default UniSat
