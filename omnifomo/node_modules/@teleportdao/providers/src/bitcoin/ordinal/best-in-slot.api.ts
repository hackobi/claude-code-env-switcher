import { AxiosInstance } from "axios"
import { getAxiosInstance } from "../../utils/tools"

export interface BISTransferInfo {
  is_valid: boolean
  ticker: string
  amount: string
  is_used: boolean
}

export interface BISMintInfo {
  is_valid: boolean
  ticker: string
  amount: string
  mint_wallet: any
}

export interface BISDeployInfo {
  is_valid: boolean
  ticker: any
  max_supply: any
  decimals: any
  limit_per_mint: any
}

export interface BISBrc20InscriptionInfo {
  data: {
    transfer_info: BISTransferInfo
    mint_info: BISMintInfo
    deploy_info: BISDeployInfo
  }
  block_height: number
}

export interface BISCollection {
  name: string
  slug: string
  inscription_icon_id: string
  icon_url: string
  bis_url: string
  supply: string
  min_number: number
  median_number: number
  max_number: number
  listed_count: number
  floor_price: any
  floor_price_ordswap: any
  floor_price_magiceden: any
  floor_price_ordinalswallet: any
  floor_price_gammaio: any
  floor_price_ordynals: any
  floor_price_ordinalsmarket: any
  floor_price_okx: any
  vol_24h_in_btc: number
  vol_7d_in_btc: number
  sale_cnt_7d: number
  vol_total_in_btc: number
  sale_cnt_total: number
  marketcap: number
}

export interface BISAllCollections {
  data: BISCollection[]
  block_height: number
}

export interface BISCollectionInfo {
  data: {
    name: string
    twitter_link: string
    discord_link: string
    website_link: string
    description: string
    supply: string
    inscription_icon_id: string
    min_number: number
    median_number: number
    max_number: number
    icon_url: string
    bis_url: string
  }
  block_height: number
}

export interface BISCollectionInscriptions {
  data: {
    name: string
    inscription_id: string
    inscription_number: number
    metadata: any
    owner_wallet_addr: string
    mime_type: string
    last_transfer_block_height: number
    genesis_height: number
    last_sale_price: number
    content_url: string
    bis_url: string
  }[]
  block_height: number
}

export interface BISWalletInscriptions {
  data: {
    inscription_name: string | null
    inscription_id: string
    inscription_number: number
    metadata: any
    owner_wallet_addr: string
    mime_type: string
    last_sale_price: any
    slug: string | null
    collection_name: string | null
    satpoint: string
    last_transfer_block_height: number
    genesis_height: number
    content_url: string
    bis_url: string
  }[]
  block_height: number
}

export interface BISWalletSatNames {
  data: {
    name: string
    inscription_id: string
    inscription_number: number
  }[]
  block_height: number
}

export interface BISWalletBalanceData {
  ticker: string
  overall_balance: string
  available_balance: string
  transferrable_balance: string
  image_url: any
  min_listed_unit_price: any
}

export interface BISWalletBalances {
  data: BISWalletBalanceData[]
  block_height: number
}

export interface BISTickerInfo {
  data: {
    ticker: string
    image_url: string | null
    decimals: number
    limit_per_mint: number
    max_supply: number
    minted_supply: number
    mint_progress: number
    holder_count: number
    tx_count: number
    deploy_ts: string
    deploy_incr_number: number
  }

  block_height: number
}

export interface BISTickerTxHistory {
  data: {
    inscription_id: string
    inscription_number: number
    ticker: string
    transfer_amount: string
    is_valid: boolean
    is_used: boolean
    satpoint: string
    min_price: string | null
    min_unit_price: string | null
    ordinalswallet_price: string | null
    ordinalswallet_unit_price: string | null
    unisat_price: string | null
    unisat_unit_price: string | null
  }
  block_height: number
}

export class BestInSlotBrc20 {
  api: AxiosInstance

  constructor(
    {
      token,
    }: {
      token: string
    },
    testnet = false,
  ) {
    const baseUrl = testnet ? "https://testnet.api.bestinslot.xyz" : "https://api.bestinslot.xyz"
    // this.apiKey = serviceConfig.bestInSlot
    this.api = getAxiosInstance({
      baseUrl,
      headers: {
        "x-api-key": token,
      },
    })
  }

  // brc20
  async getBrc20InscriptionInfo(inscriptionId: string) {
    const response: BISBrc20InscriptionInfo = (
      await this.api.get(`/v3/brc20/single_info`, {
        params: {
          inscription_id: inscriptionId,
        },
      })
    )?.data
    if ((response.data as any) === "no-data") {
      return
    }
    // eslint-disable-next-line consistent-return
    return response.data
  }

  async getBrc20TickerInfo(ticker: string) {
    const response: BISTickerInfo = (
      await this.api.get(`/v3/brc20/ticker_info`, {
        params: {
          ticker,
        },
      })
    )?.data
    return response.data
  }

  async getBrc20TickerTxHistory(ticker: string, offset = 0) {
    const response: BISTickerTxHistory = (
      await this.api.get(`/v3/brc20/validtxnotes`, {
        params: {
          ticker,
          sort_by: "inscr_num",
          order: "asc",
          offset,
          // 20 <= count <= 2000, count must be a multiple of 20
          count: 20 * 3,
          exclude_brc20: false,
          cursed_only: false,
        },
      })
    )?.data
    return response.data
  }

  async getBrc20AddressTickerTxHistory(address: string, ticker: string, offset = 0) {
    const response: BISTickerTxHistory = (
      await this.api.get(`/v3/brc20/validtxnotes_wallet`, {
        params: {
          ticker,
          address,
          sort_by: "inscr_num",
          order: "asc",
          offset,
          // 20 <= count <= 2000, count must be a multiple of 20
          count: 20 * 3,
          exclude_brc20: false,
          cursed_only: false,
        },
      })
    )?.data
    return response.data
  }

  async getBrc20AddressBalances(address: string) {
    const response: BISWalletBalances = (
      await this.api.get(`/v3/brc20/wallet_balances`, {
        params: {
          address,
        },
      })
    )?.data
    return response.data
  }

  async getBrc20AddressBalanceForTicker(address: string, ticker: string) {
    const response: BISWalletBalances = (
      await this.api.get(`/v3/brc20/wallet_balances`, {
        params: {
          address,
          ticker,
        },
      })
    )?.data
    return response.data[0]
  }

  // Get BRC-20 Ticker Count

  // collections
  async getCollections() {
    const response: BISBrc20InscriptionInfo = (
      await this.api.get(`/v3/collection/collections`, {
        params: {
          // supply, min_number, median_number, max_number
          // pro : listed_count, floor_price, floor_price_ordswap, floor_price_magiceden, floor_price_ordinalswallet, floor_price_gammaio, floor_price_ordynals, floor_price_ordinalsmarket, floor_price_okx, vol_24h_in_btc, vol_7d_in_btc, sale_cnt_7d, vol_total_in_btc, sale_cnt_total, marketcap
          sort_by: "supply",
          order: "asc",
          offset: 0,
          // 20 <= count <= 100, count must be a multiple of 20
          count: 20 * 3,
        },
      })
    )?.data
    return response
  }

  async getCollectionInfo(slug: string) {
    const response: BISBrc20InscriptionInfo = (
      await this.api.get(`/v3/collection/info`, {
        params: {
          slug,
        },
      })
    )?.data
    return response
  }

  async getCollectionInscriptions(slug: string, offset = 0) {
    const response: BISCollectionInscriptions = (
      await this.api.get(`/v3/collection/inscriptions`, {
        params: {
          slug,
          //
          sort_by: "inscr_num",
          order: "asc",
          offset,
          // 20 <= count <= 100, count must be a multiple of 20
          count: 20 * 3,
        },
      })
    )?.data
    return response
  }

  // wallet
  async getWalletInscriptions(address: string, offset = 0) {
    const response: BISWalletInscriptions = (
      await this.api.get(`/v3/wallet/inscriptions`, {
        params: {
          address,
          //
          sort_by: "inscr_num",
          order: "asc",
          offset,
          // 20 <= count <= 2000, count must be a multiple of 20
          count: 20 * 3,
          exclude_brc20: false,
          cursed_only: false,
        },
      })
    )?.data
    return response
  }

  async getWalletSatNames(address: string, offset = 0) {
    const response: BISWalletSatNames = (
      await this.api.get(`/v3/wallet/sats_names`, {
        params: {
          address,
        },
      })
    )?.data
    return response
  }
}

export default BestInSlotBrc20
