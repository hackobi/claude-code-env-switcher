import axios from "axios"

function sleep(ms: number) {
  // eslint-disable-next-line no-promise-executor-return
  return new Promise((resolve) => setTimeout(resolve, ms))
}

async function runWithRetries<T>(
  action: () => Promise<T>,
  config: {
    maxTries?: number
    retrySleep?: number
  } = {
    maxTries: 2,
    retrySleep: 1000,
  },
): Promise<T> {
  const maxTries = config.maxTries ?? 2
  const retrySleep = config.retrySleep ?? 1000
  const trace = new Error().stack?.split("\n").slice(5).join("\n")

  let lastError: any
  for (let count = 0; count < maxTries; count += 1) {
    try {
      return await action()
    } catch (error: any) {
      error.message += `\n${trace}`
      console.log(`Attempt ${count + 1} failed: ${error.message}`)
      lastError = error
      if (count < maxTries - 1) {
        await sleep(retrySleep)
      }
    }
  }

  throw lastError || new Error(`Function failed after ${maxTries} retries: ${lastError?.message}`)
}

function getRandomInteger(min: number, max: number) {
  return Math.floor(Math.random() * (max - min)) + min
}

function getAxiosInstance({
  baseUrl,
  timeout = 10000,
  headers = {},
  auth,
}: {
  baseUrl: string
  timeout?: number
  headers?: { [key: string]: string }
  auth?: {
    username: string
    password: string
  }
}) {
  let host = baseUrl
  let instance

  instance = axios.create({
    baseURL: host,
    timeout,
    auth,
    headers: {
      ...headers,
    },
  })

  // Add a response interceptor
  instance.interceptors.response.use(
    (response) => response,
    (error) => {
      // todo : fix this part
      if (error.response) {
        const serviceError = new Error(
          JSON.stringify({ data: error.response.data, message: error.message }),
        )
        return Promise.reject(serviceError)
      }

      if (error.request) {
        const serviceError = new Error(
          error.message +
            ". details: " +
            JSON.stringify(
              {
                baseURL: error.config.baseURL,
                url: error.config.url,
                method: error.config.method,
                data: error.config.data,
              },
              null,
              2,
            ),
        )
        return Promise.reject(serviceError)
      }
      return Promise.reject(error)
    },
  )

  return instance
}

export { sleep, runWithRetries, getRandomInteger, getAxiosInstance }
