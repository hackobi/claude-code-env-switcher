import { EventLog } from "web3"

interface Job {
  id: string
  data: EventLog
}

export class JobQueueInOrder {
  queue: Job[]
  isProcessing: boolean
  uniqueJobId: boolean
  processJob: (job: Job) => Promise<void>

  constructor(uniqueJobId = false, processJob: (job: Job) => Promise<void>) {
    this.uniqueJobId = uniqueJobId
    this.queue = []
    this.isProcessing = false
    this.processJob = processJob
  }

  public addJob(job: Job): void {
    // Check if job ID already exists in the queue
    const jobExists = this.uniqueJobId
      ? this.queue.some((existingJob) => existingJob.id === job.id)
      : false
    if (!jobExists) {
      this.queue.push(job)
      this.processQueue()
    } else {
      console.log(`Job with ID ${job.id} already exists in the queue and will not be added again.`)
    }
  }

  async processQueue(): Promise<void> {
    if (this.isProcessing) {
      return
    }
    this.isProcessing = true
    while (this.queue.length > 0) {
      const job = this.queue.shift()
      if (job) {
        await this.processJob(job).catch((e) => {
          console.error(`Error processing job with ID ${job.id}:`, e.message)
        })
      }
    }
    this.isProcessing = false
  }
}
