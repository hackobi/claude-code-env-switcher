import { ContractEventsInterface } from "web3-eth-contract"
import { BitcoinRelayABI } from "../../abis"
import ContractBase from "../contract-base"
import { ConnectionConfig, TxInfo } from "../../types/eth"

export type BlockAdded = {
  height: bigint
  selfHash: string
  parentHash: string
  relayer: string
}

export type BlockFinalized = {
  height: bigint
  selfHash: string
  parentHash: string
  relayer: string
  rewardAmountTNT: bigint
  rewardAmountTDT: bigint
}

export class BitcoinRelay extends ContractBase<typeof BitcoinRelayABI> {
  constructor(connectionConfig: ConnectionConfig, contractAddress: string) {
    super(connectionConfig, contractAddress, BitcoinRelayABI)
  }

  async firstSubmittedHeight() {
    const firstSubmittedHeight = await this.contract.methods.initialHeight().call()
    return firstSubmittedHeight.toString()
  }

  // read method
  async isBlockHashSubmitted(blockHash: string, blockHeight: number) {
    // search to see if blockHash has been submitted on the relay
    const BlockHashWith0x = `0x${Buffer.from(blockHash, "hex").reverse().toString("hex")}`
    const numberOfSubmittedHeaders = await this.getNumberOfSubmittedHeaders(blockHeight)

    for (let i = 0; i < numberOfSubmittedHeaders; i += 1) {
      const submittedBlockHeaderHash = await this.getSubmittedHeaderHash(blockHeight, i)
      if (BlockHashWith0x === submittedBlockHeaderHash) {
        return true
      }
    }
    return false
  }

  async lastSubmittedHeight() {
    const lastSubmittedHeight = await this.contract.methods.lastSubmittedHeight().call()
    return lastSubmittedHeight.toString()
  }

  async getNumberOfSubmittedHeaders(height: number) {
    const numberOfSubmittedHeaders = await this.contract.methods
      .getNumberOfSubmittedHeaders(height)
      .call()
    return +numberOfSubmittedHeaders.toString()
  }

  async getSubmittedHeaderHash(height: number, index: number) {
    const blockHeaderHash = await this.contract.methods.getBlockHeaderHash(height, index).call()
    return blockHeaderHash
  }

  async getBlockHeaderFee(height: number, index: number) {
    const blockHeaderHash = await this.contract.methods.getBlockHeaderFee(height, index).call()
    return blockHeaderHash
  }

  // write method
  async submitBlockHeadersWithRetarget(
    oldPeriodStartHeader: string,
    oldPeriodEndHeader: string,
    newBlockHeaders: string,
  ) {
    return this.contractSendMethod("addHeadersWithRetarget", "0", [
      oldPeriodStartHeader,
      oldPeriodEndHeader,
      newBlockHeaders,
    ])
  }

  async submitBlockHeaders(anchorBlockHeader: string, newBlockHeaders: string) {
    return this.contractSendMethod("addHeaders", "0", [anchorBlockHeader, newBlockHeaders])
  }

  async getNumberOfConfirmations() {
    const finalizationParameter = await this.contract.methods.finalizationParameter().call()
    return finalizationParameter.toString()
  }

  async getLastBlockFee() {
    const blockHeight = await this.lastSubmittedHeight()
    const numberOfSubmittedHeaders = await this.getNumberOfSubmittedHeaders(+blockHeight)
    return this.getBlockHeaderFee(+blockHeight, +numberOfSubmittedHeaders - 1)
  }
}
export default BitcoinRelay
