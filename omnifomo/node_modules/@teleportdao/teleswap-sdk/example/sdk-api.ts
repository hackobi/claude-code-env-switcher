import { BigNumber } from "bignumber.js"
import { toChecksumAddress } from "web3-utils"
import { tokens } from "@teleportdao/configs"
import { contracts } from "@teleportdao/contracts-helper"
import { TeleswapSDK } from "../src"
import { TeleswapUtilsAPI } from "./class/teleswap-utils-api"

async function start() {
  console.log("start")

  const teleportdaoAPI = new TeleswapUtilsAPI()
  // const teleportdaoAPI = new TeleswapUtilsAPI("http://localhost:8000/api")
  // const teleportdaoAPI = new TeleswapSDK()
  // teleportdaoAPI.setDefaultNetwork({
  //   networkName: "polygon",
  // })
  // await teleportdaoAPI.initNetworksConnection()

  const sdk = new TeleswapSDK()
  sdk.setDefaultNetwork({
    networkName: "polygon",
  })
  await sdk.initNetworksConnection()

  const network = "polygon"
  const crosschainNetwork = "optimism"
  const crossTokens = tokens[crosschainNetwork].mainnet
  const networkTokens = tokens[network].mainnet
  let thirdPartyId: undefined | number = 10

  //
  const evmARecipientAddress = "0xE0166434A2ad67536B5FdAFCc9a6C1B41CC5e085"
  const btcRecipientAddress = "3H5cLbSHJ5UHXjeUXu81aWekerLgWHmoNB"

  //
  const signerInfo = {
    address: "bc1qxgyzuxmvdqvzzct76dxhlmdy07dysd47ps9awk",
    publicKey: "02bd17b29437771d694a61750525b69ba542467d9569a1caeb5d3f95bec47ad1c8",
    addressType: "p2wpkh",
  }

  const wrapAndSwapEstimate = await teleportdaoAPI.wrapAndSwapEstimate(
    "0.0004",
    network,
    networkTokens.USDCAddress,
    thirdPartyId,
  )
  console.log("wrapAndSwapEstimate", JSON.stringify(wrapAndSwapEstimate, null, 2))

  const wrapAndSwapNativeTokenEstimate = await teleportdaoAPI.wrapAndSwapEstimate(
    "0.0004",
    network,
    undefined,
    thirdPartyId,
  )
  console.log(
    "wrapAndSwapNativeTokenEstimate",
    JSON.stringify(wrapAndSwapNativeTokenEstimate, null, 2),
  )

  // crosschain
  const wrapAndSwapCrossChainEstimate = await teleportdaoAPI.wrapAndSwapEstimate(
    "0.005",
    crosschainNetwork,
    crossTokens.USDCAddress,
    thirdPartyId,
  )

  console.log(
    "wrapAndSwapCrossChainEstimate",
    JSON.stringify(wrapAndSwapCrossChainEstimate, null, 2),
  )

  const wrapAndSwapCrossChainNativeTokenEstimate = await teleportdaoAPI.wrapAndSwapEstimate(
    "0.001",
    crosschainNetwork,
    undefined,
    thirdPartyId,
  )
  console.log(
    "wrapAndSwapCrossChainNativeTokenEstimate",
    JSON.stringify(wrapAndSwapCrossChainNativeTokenEstimate, null, 2),
  )

  const unsignedWrapAndSwap = await teleportdaoAPI.wrapAndSwapUnsigned(
    evmARecipientAddress,
    "0.00002",
    signerInfo,
    network,
    networkTokens.USDC_EAddress,
    undefined,
    undefined,
    undefined,
    undefined,
    undefined,
    thirdPartyId,
  )
  console.log("unsignedWrapAndSwap", JSON.stringify(unsignedWrapAndSwap, null, 2))

  // crosschain
  const unsigendPsbtCrosschain = await teleportdaoAPI.wrapAndSwapUnsigned(
    evmARecipientAddress,
    "0.0001",
    signerInfo,
    crosschainNetwork,
    crossTokens.USDCAddress,
    undefined,
    undefined,
    undefined,
    undefined,
    undefined,
    thirdPartyId,
  )
  console.log("unsigendPsbtCrosschain", JSON.stringify(unsigendPsbtCrosschain, null, 2))

  const token = new contracts.ERC20(
    sdk.getNetwork(network).targetConnectionConfig,
    toChecksumAddress(networkTokens.USDTAddress!),
  )
  const decimal = +(await token.getDecimal()).toString()
  const amount = BigNumber("200")
    .multipliedBy(10 ** decimal)
    .toFixed(0)
  // const amount = (await token.getBalance(evmARecepientAddress)).toString()

  const unwrapAndSwapBaseEstimate = await teleportdaoAPI.swapAndUnwrapEstimate(
    {
      inputToken: token.contractAddress!,
      inputAmount: amount,
    },
    network,
    thirdPartyId,
  )

  console.log("unwrapAndSwapBaseEstimate", JSON.stringify(unwrapAndSwapBaseEstimate, null, 2))

  const unwrapAndSwapBaseNativeTokenEstimate = await teleportdaoAPI.swapAndUnwrapEstimate(
    {
      // inputToken: undefined,
      inputAmount: (100 * 1e18).toFixed(),
    },
    network,
    thirdPartyId,
  )
  console.log(
    "unwrapAndSwapBaseNativeTokenEstimate",
    JSON.stringify(unwrapAndSwapBaseNativeTokenEstimate, null, 2),
  )

  // normal
  const unwrapAndSwapBase = await teleportdaoAPI.swapAndUnwrapInputs(
    {
      inputToken: token.contractAddress!,
      inputAmount: amount,
    },
    btcRecipientAddress,
    network,
    undefined,
    thirdPartyId,
  )
  console.log("unwrapAndSwapBase", JSON.stringify(unwrapAndSwapBase, null, 2))

  // normal
  const unwrapAndSwapBaseNative = await teleportdaoAPI.swapAndUnwrapInputs(
    {
      // inputToken: token.contractAddress!,
      inputAmount: (50 * 1e18).toFixed(),
    },
    btcRecipientAddress,
    network,
    undefined,
    thirdPartyId,
  )
  console.log("unwrapAndSwapBaseNative", JSON.stringify(unwrapAndSwapBaseNative, null, 2))

  // crosschain

  const crossChainToken = new contracts.ERC20(
    sdk.getCrossChainNetwork(crosschainNetwork).targetConnectionConfig,
    toChecksumAddress(crossTokens.USDTAddress!),
  )
  const decimalCrosschain = +(await crossChainToken.getDecimal()).toString()
  const amountCrossChain = BigNumber("20")
    .multipliedBy(10 ** decimalCrosschain)
    .toFixed(0)

  const unwrapAndSwapCrosschainEstimate = await teleportdaoAPI.swapAndUnwrapEstimate(
    {
      inputToken: crossChainToken.contractAddress,
      inputAmount: amountCrossChain,
    },
    crosschainNetwork,
    thirdPartyId,
  )
  console.log(
    "unwrapAndSwapCrosschainEstimate",
    JSON.stringify(unwrapAndSwapCrosschainEstimate, null, 2),
  )

  //

  const unwrapAndSwapCrosschainNativeEstimate = await teleportdaoAPI.swapAndUnwrapEstimate(
    {
      inputAmount: (10 * 1e18).toFixed(),
    },
    crosschainNetwork,
    thirdPartyId,
  )
  console.log(
    "unwrapAndSwapCrosschainNativeEstimate",
    JSON.stringify(unwrapAndSwapCrosschainNativeEstimate, null, 2),
  )

  const unwrapAndSwapCrosschain = await teleportdaoAPI.swapAndUnwrapInputs(
    {
      inputToken: crossChainToken.contractAddress,
      inputAmount: amountCrossChain,
    },
    btcRecipientAddress,
    crosschainNetwork,
    undefined,
    thirdPartyId,
  )
  console.log("unwrapAndSwapCrosschain", JSON.stringify(unwrapAndSwapCrosschain, null, 2))

  const unwrapAndSwapCrosschainNative = await teleportdaoAPI.swapAndUnwrapInputs(
    {
      inputAmount: (1e18).toFixed(),
    },
    btcRecipientAddress,
    crosschainNetwork,
    undefined,
  )
  console.log(
    "unwrapAndSwapCrosschainNative",
    JSON.stringify(unwrapAndSwapCrosschainNative, null, 2),
  )
}

start()
