import { BigNumber } from "bignumber.js"
import { toChecksumAddress } from "web3-utils"
import { tokens } from "@teleportdao/configs"
import { contracts } from "@teleportdao/contracts-helper"
import { TeleswapSDK } from "../src"

async function start() {
  console.log("start")

  const sdk = new TeleswapSDK()
  sdk.setDefaultNetwork({
    networkName: "polygon",
  })
  await sdk.initNetworksConnection()

  const network = "polygon"
  const crosschainNetwork = "optimism"
  const crossTokens = tokens[crosschainNetwork].mainnet
  const networkTokens = tokens[network].mainnet

  //
  const evmARecipientAddress = "0xE0166434A2ad67536B5FdAFCc9a6C1B41CC5e085"
  const btcRecipientAddress = "3H5cLbSHJ5UHXjeUXu81aWekerLgWHmoNB"

  //
  const signerInfo = {
    address: "bc1qxgyzuxmvdqvzzct76dxhlmdy07dysd47ps9awk",
    publicKey: "02bd17b29437771d694a61750525b69ba542467d9569a1caeb5d3f95bec47ad1c8",
    addressType: "p2wpkh",
  }

  // // normal
  const unsigned = await sdk.wrapUnsigned(evmARecipientAddress, "0.0001", signerInfo, network)
  console.log("unsigned", unsigned)

  const unsignedWrapAndSwap = await sdk.wrapAndSwapUnsigned(
    evmARecipientAddress,
    "0.00002",
    signerInfo,
    network,
    networkTokens.USDC_EAddress,
  )
  console.log("unsignedWrapAndSwap", unsignedWrapAndSwap)

  // crosschain
  const unsigendPsbtCrosschain = await sdk.wrapAndSwapUnsigned(
    evmARecipientAddress,
    "0.0001",
    signerInfo,
    crosschainNetwork,
    crossTokens.USDCAddress,
  )
  console.log("unsigendPsbtCrosschain", unsigendPsbtCrosschain)

  // unwrap normal
  const unwrapInputs = await sdk.unwrapInputs("0.001", btcRecipientAddress, network)
  console.log("unwrapInputs", unwrapInputs)
  //

  const token = new contracts.ERC20(
    sdk.getNetwork(network).targetConnectionConfig,
    toChecksumAddress(networkTokens.USDTAddress!),
  )
  const decimal = +(await token.getDecimal()).toString()
  const amount = BigNumber("10")
    .multipliedBy(10 ** decimal)
    .toFixed(0)
  // const amount = (await token.getBalance(evmARecepientAddress)).toString()

  // normal
  const unwrapAndSwapBase = await sdk.swapAndUnwrapInputs(
    {
      inputToken: token.contractAddress!,
      inputAmount: amount,
    },
    btcRecipientAddress,
    network,
  )
  console.log("unwrapAndSwapBase", JSON.stringify(unwrapAndSwapBase, null, 2))

  // normal
  const unwrapAndSwapBaseNative = await sdk.swapAndUnwrapInputs(
    {
      // inputToken: token.contractAddress!,
      inputAmount: (50 * 1e18).toFixed(),
    },
    btcRecipientAddress,
    network,
  )
  console.log("unwrapAndSwapBaseNative", JSON.stringify(unwrapAndSwapBaseNative, null, 2))

  // crosschain

  const crossChainToken = new contracts.ERC20(
    sdk.getCrossChainNetwork(crosschainNetwork).targetConnectionConfig,
    toChecksumAddress(crossTokens.USDTAddress!),
  )
  const decimalCrosschain = +(await crossChainToken.getDecimal()).toString()
  const amountCrossChain = BigNumber("20")
    .multipliedBy(10 ** decimalCrosschain)
    .toFixed(0)

  const unwrapAndSwapCrosschain = await sdk.swapAndUnwrapInputs(
    {
      inputToken: crossChainToken.contractAddress,
      inputAmount: amountCrossChain,
    },
    btcRecipientAddress,
    crosschainNetwork,
  )
  console.log("unwrapAndSwapCrosschain", JSON.stringify(unwrapAndSwapCrosschain, null, 2))

  const unwrapAndSwapCrosschainNative = await sdk.swapAndUnwrapInputs(
    {
      inputAmount: (1e18).toFixed(),
    },
    btcRecipientAddress,
    crosschainNetwork,
  )
  console.log(
    "unwrapAndSwapCrosschainNative",
    JSON.stringify(unwrapAndSwapCrosschainNative, null, 2),
  )
}

start()
