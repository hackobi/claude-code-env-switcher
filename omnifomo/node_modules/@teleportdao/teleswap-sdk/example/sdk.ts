import { BigNumber } from "bignumber.js"
import { toChecksumAddress } from "web3-utils"
import { tokens } from "@teleportdao/configs"
import { contracts } from "@teleportdao/contracts-helper"
import { TeleswapSDK } from "../src"

async function start() {
  const account = {
    mnemonic: "",
    addressType: "p2wpkh",
  }
  const sdk = new TeleswapSDK()
  sdk.setDefaultNetwork({
    networkName: "polygon",
  })
  await sdk.initNetworksConnection()
  const sdkBitcoinAddress = sdk.initBitcoinAccountUsingMnemonic(
    account.mnemonic,
    account.addressType,
  )
  const sdkEvmAddress = sdk.initEvmAccountUsingMnemonic(account.mnemonic)

  console.log(sdkBitcoinAddress)
  console.log(sdkEvmAddress)

  console.log(sdk.bitcoinAddress, sdk.bitcoinAddressType)
  console.log(sdk.evmAddress)

  const network = "polygon"
  const crosschainNetwork = "optimism"
  const crossTokens = tokens[crosschainNetwork].mainnet
  const networkTokens = tokens[network].mainnet

  const evmRecipientAddress = "0x.......0000000"
  const btcRecipientAddress = "bc1q0...dv"

  // normal
  const wrapTxId = await sdk.wrap(evmRecipientAddress, "0.001", network)
  console.log("wrapTxId", wrapTxId)

  // crosschain
  const wrapAndSwapTxId = await sdk.wrapAndSwap(
    evmRecipientAddress,
    "0.001",
    crosschainNetwork,
    networkTokens.USDC_EAddress!,
  )
  console.log("wrapAndSwapTxId", wrapAndSwapTxId)

  // unwrap normal
  const unwrap = await sdk.unwrap("0.001", btcRecipientAddress, network)
  console.log("unwrap", unwrap)
  //

  const token = new contracts.ERC20(
    sdk.getNetwork(network).targetConnectionConfig,
    toChecksumAddress(networkTokens.USDTAddress!),
  )

  const decimal = +(await token.getDecimal()).toString()

  const amount = BigNumber("10")
    .multipliedBy(10 ** decimal)
    .toFixed(0)

  // normal
  const unwrapAndSwapBase = await sdk.swapAndUnwrap(
    {
      inputToken: token.contractAddress!,
      inputAmount: amount,
    },
    btcRecipientAddress,
    network,
  )
  console.log("unwrapAndSwapBase", JSON.stringify(unwrapAndSwapBase, null, 2))

  // crosschain

  const crossChainToken = new contracts.ERC20(
    sdk.getCrossChainNetwork(crosschainNetwork).targetConnectionConfig,
    toChecksumAddress(crossTokens.USDTAddress!),
  )
  const decimalCrossChain = +(await crossChainToken.getDecimal()).toString()
  const amountCrossChain = BigNumber("10")
    .multipliedBy(10 ** decimalCrossChain)
    .toFixed(0)

  const unwrapAndSwapCrossChain = await sdk.swapAndUnwrap(
    {
      inputToken: crossChainToken.contractAddress,
      inputAmount: amountCrossChain,
    },
    btcRecipientAddress,
    crosschainNetwork,
  )
  console.log("unwrapAndSwapCrossChain", JSON.stringify(unwrapAndSwapCrossChain, null, 2))

  //  exchange eth to TELEBTC
  const unwrapAndSwapCrossChainETH = await sdk.swapAndUnwrap(
    {
      // inputToken: undefined, // no need to set inputToken
      inputAmount: amountCrossChain, // input amount in wei
    },
    btcRecipientAddress,
    crosschainNetwork,
  )
  console.log("unwrapAndSwapCrossChainETH", JSON.stringify(unwrapAndSwapCrossChainETH, null, 2))
}

start()
