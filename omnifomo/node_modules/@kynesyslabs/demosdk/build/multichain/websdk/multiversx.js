"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.MULTIVERSX = void 0;
const core_1 = require("../core");
const sdk_extension_provider_1 = require("@multiversx/sdk-extension-provider");
const sdk_wallet_1 = require("@multiversx/sdk-wallet");
class MULTIVERSX extends core_1.MULTIVERSX {
    constructor(rpc_url) {
        super(rpc_url);
    }
    getAddress() {
        // INFO: method is overriden in the web sdk
        (0, core_1.required)(this.wallet, "Wallet not connected");
        if (this.wallet instanceof sdk_extension_provider_1.ExtensionProvider) {
            return this.wallet.account.address;
        }
        else if (this.wallet instanceof sdk_wallet_1.UserSigner) {
            return this.wallet.getAddress().bech32();
        }
        throw new Error("Unknown wallet type. Can't get address.");
    }
    /**
     * Connect a Multiversx wallet. Pass the `keyFile` JSON string as the `privateKey` and its `password` to override the De-Fi wallet prompt.
     */
    // @ts-expect-error // INFO: Return type error
    async connectWallet(privateKey, options) {
        if (privateKey && options && options?.password) {
            this.wallet = await this.connectKeyFileWallet(privateKey, options.password);
            return this.wallet;
        }
        this.wallet = sdk_extension_provider_1.ExtensionProvider.getInstance();
        await this.wallet.init();
        // INFO: wallet.isInitialized() checks if the wallet is installed.
        // It's equivalent to checking for `window.elrondWallet` object which is injected by the extension
        // LINK to src: https://github.com/multiversx/mx-sdk-js-extension-provider/blob/36518d0fe0b295de8d2b977727f0c30cdc014c78/src/extensionProvider.ts#L45
        if (!this.wallet.isInitialized()) {
            throw new Error("Wallet not detected. Is the MultiversX DeFi Wallet extension installed?");
        }
        await this.wallet.login();
        return this.wallet;
    }
    async signTransactions(transactions, options) {
        (0, core_1.required)(this.wallet || options?.privateKey, "Wallet not connected");
        // INFO: Override wallet connection
        if (options?.privateKey) {
            await this.connectWallet(options.privateKey, {
                password: options.password,
            });
        }
        transactions = await this.addTxNonces(transactions);
        try {
            // INFO: When wallet is loaded from Extension
            transactions = await this.wallet.signTransactions(transactions);
        }
        catch (error) {
            for (const tx of transactions) {
                const serializedTx = tx.serializeForSigning();
                const txSign = await this.wallet.sign(serializedTx);
                tx.applySignature(txSign);
            }
        }
        return transactions.map(tx => {
            // INFO: Return plain objects
            return tx.toSendable();
        });
    }
}
exports.MULTIVERSX = MULTIVERSX;
//# sourceMappingURL=multiversx.js.map