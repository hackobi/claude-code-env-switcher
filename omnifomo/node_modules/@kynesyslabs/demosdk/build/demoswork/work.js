"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.DemosWork = void 0;
exports.prepareDemosWorkPayload = prepareDemosWorkPayload;
const websdk_1 = require("../websdk");
const validator_1 = require("./validator");
class DemosWork {
    constructor() {
        this.script = {
            operationOrder: new Set(),
            operations: {},
            steps: {},
        };
        // INFO: Step results indexed by stepUID
        this.results = {};
        // TODO: Add static methods for adding and retrieving step results
    }
    push(operation) {
        // @ts-expect-error
        // INFO: Add operation to the script
        this.script.operations[operation.operationScript.id] =
            operation.operationScript;
        this.script.operationOrder.add(operation.operationScript.id);
        // INFO: Add steps used by the operation to the script
        for (const stepUID in operation.steps) {
            this.script.steps[stepUID] = operation.steps[stepUID];
        }
        // INFO: Add operations used by the operation to the script
        for (const op of operation.operations) {
            // @ts-expect-error
            this.script.operations[op.operationScript.id] = op.operationScript;
        }
    }
    validate(script) {
        (0, validator_1.runSanityChecks)(script);
    }
    fromJSON(script) {
        let newscript = script;
        newscript.operationOrder = new Set(script.operationOrder);
        this.script = script;
        return this;
    }
    // async execute() {
    //     return await executeScript(this)
    // }
    toJSON() {
        let script = this.script;
        // @ts-expect-error
        // convert set to array
        script.operationOrder = [...script.operationOrder];
        // remove all step outputs
        for (const stepUID in script.steps) {
            console.log("stepUID", script.steps[stepUID]);
            delete script.steps[stepUID].id;
        }
        // remove all operation uids
        for (const opUID in script.operations) {
            delete script.operations[opUID].id;
        }
        this.validate(script);
        // return JSON.stringify(script)
        return script;
    }
}
exports.DemosWork = DemosWork;
async function prepareDemosWorkPayload(work, demos) {
    const script = work.toJSON();
    let tx = websdk_1.DemosTransactions.empty();
    // tx.content.from = demos.keypair.publicKey
    tx.content.to = tx.content.from;
    tx.content.type = "demoswork";
    tx.content.data = ["demoswork", script];
    tx.content.timestamp = Date.now();
    tx = await demos.sign(tx);
    return tx;
}
//# sourceMappingURL=work.js.map